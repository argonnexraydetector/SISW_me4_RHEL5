PROJECT(LinuxDriver C)

CMAKE_MINIMUM_REQUIRED(VERSION 2.8.2)

INCLUDE(CTest)
INCLUDE(ExternalProject)

FIND_PROGRAM(UNAME NAMES uname)
MACRO(getuname name flag)
	EXEC_PROGRAM("${UNAME}" ARGS "${flag}" OUTPUT_VARIABLE "${name}")
ENDMACRO(getuname)

getuname(cpu -m)
getuname(kversion -r)
SET(BUILDNAME "${CMAKE_C_COMPILER_ID}-${cpu}")
INCLUDE(CTest)

ENABLE_TESTING()

SET(KERNELDIR /home/kernel)

IF (cpu STREQUAL "i686")
	SET(PLATFORM "i386")
ELSE (cpu STREQUAL "i686")
	SET(PLATFORM ${cpu})
ENDIF (cpu STREQUAL "i686")

FUNCTION(FIND_CROSS_COMPILE _KERNEL_BUILD_DIR _MAKE_EXTRA_ARGS)
	FILE(STRINGS ${_KERNEL_BUILD_DIR}/.config _CROSS_COMPILE REGEX "^CONFIG_CROSS_COMPILE=")
	IF (_CROSS_COMPILE)
		STRING(REGEX REPLACE "^CONFIG_" "" _MAKE_EXTRA ${_CROSS_COMPILE})
		SET(${_MAKE_EXTRA_ARGS} ${_MAKE_EXTRA} PARENT_SCOPE)
	ENDIF (_CROSS_COMPILE)
ENDFUNCTION(FIND_CROSS_COMPILE)

FILE(GLOB _CONFIGS ${CMAKE_CURRENT_SOURCE_DIR}/scripts/configs/config_${PLATFORM}_*_*)
FOREACH (_CONFIG ${_CONFIGS})
	STRING(REGEX REPLACE "^.*/config_${PLATFORM}_" "" _CONFIG_TMP ${_CONFIG})
	STRING(REPLACE "_" ";" _CONFIG_TMP ${_CONFIG_TMP})

	LIST(LENGTH _CONFIG_TMP _PART_COUNT)

	IF (NOT _PART_COUNT EQUAL 2)
		MESSAGE(ERROR "Can not split the name of kernel config file ${_CONFIG}: ${_PART_COUNT} relevant parts found, expected 2")
	ENDIF (NOT _PART_COUNT EQUAL 2)

	LIST(GET _CONFIG_TMP 0 KV)
	LIST(GET _CONFIG_TMP 1 ARCH)

	SET(BUILDDIR_EXISTS)
	FILE(GLOB BUILDDIR_EXISTS ${KERNELDIR}/build/${KV}/${PLATFORM}_${ARCH})
	IF (BUILDDIR_EXISTS)
		ADD_CUSTOM_TARGET(driver_${PLATFORM}_${KV}_${ARCH} ALL VERBATIM)

		SET(_KERNEL_BUILD_DIR ${KERNELDIR}/build/${KV}/${PLATFORM}_${ARCH})

		FIND_CROSS_COMPILE(${_KERNEL_BUILD_DIR} MAKE_EXTRA_ARGS)

		ADD_CUSTOM_COMMAND(TARGET driver_${PLATFORM}_${KV}_${ARCH}
				POST_BUILD
				COMMAND make clean
				COMMAND make ${MAKE_EXTRA_ARGS} M=${CMAKE_CURRENT_SOURCE_DIR} O=${_KERNEL_BUILD_DIR}/ -C ${KERNELDIR}/linux-${KV}
				COMMAND cmake -E copy menable.ko ${CMAKE_CURRENT_BINARY_DIR}/menable-${PLATFORM}_${ARCH}_${KV}.ko
				WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
				VERBATIM)
		ADD_TEST(NAME modinfo-${PLATFORM}_${ARCH}_${KV}
			COMMAND /sbin/modinfo ${CMAKE_CURRENT_BINARY_DIR}/menable-${PLATFORM}_${ARCH}_${KV}.ko)
	ENDIF (BUILDDIR_EXISTS)
ENDFOREACH (_CONFIG)

#ADD_CUSTOM_TARGET(driver_${PLATFORM}_${kversion} ALL VERBATIM)
#
#FIND_CROSS_COMPILE(/lib/modules/${kversion}/build MAKE_EXTRA_ARGS)
#
#ADD_CUSTOM_COMMAND(TARGET driver_${PLATFORM}_${kversion}
#		POST_BUILD
#		COMMAND make clean
#		COMMAND make ${MAKE_EXTRA_ARGS}
#		COMMAND cmake -E copy menable.ko ${CMAKE_CURRENT_BINARY_DIR}/menable-${PLATFORM}_${kversion}.ko
#		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
#		VERBATIM)
#
#ADD_TEST(NAME modinfo-${PLATFORM}_${kversion}
#	COMMAND /sbin/modinfo ${CMAKE_CURRENT_BINARY_DIR}/menable-${PLATFORM}_${kversion}.ko)

CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/ctest_linuxdriver_local.cmake.tmpl ${CMAKE_CURRENT_BINARY_DIR}/ctest_linuxdrv_local.cmake @ONLY)
